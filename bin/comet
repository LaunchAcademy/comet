#!/usr/bin/env ruby
require 'gli'
require 'yaml'
require 'comet'

include GLI::App

program_desc 'Test your Ruby skills! Download Ruby exercises and submit your solutions for grading.'

version Comet::VERSION

desc 'Initialize the current directory as a comet project directory'
skips_pre
command :init do |c|
  c.action do |global_options, options, args|
    answers = {}

    print 'E-mail: '
    answers['email'] = gets.chomp

    print 'Token: '
    answers['token'] = gets.chomp

    print 'Server: '
    answers['server'] = gets.chomp

    Comet::Init.init_project_dir(Dir.pwd, answers)
  end
end

desc 'List the available challenges'
command :list do |c|
  c.action do |global_options,options,args|
    challenges = Comet::Challenge.list(@config)

    if challenges.empty?
      puts "No challenges available."
    else
      challenges.each do |challenge|
        puts "#{challenge[:id]}: #{challenge[:name]}"
      end
    end
  end
end

desc 'Download a challenge'
command :fetch do |c|
  c.action do |global_options, options, args|
    challenge_id = args.first
    challenge = Comet::Challenge.find(@config, challenge_id)
    directory = challenge.download

    info = { 'id' => challenge_id.to_i, 'file_name' => "#{challenge.slug}.rb" }
    info_file = File.join(directory, '.challenge')
    File.write(info_file, info.to_yaml)
  end
end

desc 'Submit challenge'
command :submit do |c|
  c.action do |global_options, options, args|
    info_file = File.join(Dir.pwd, '.challenge')

    if File.exists?(info_file)
      info = YAML.load(File.read(info_file))

      challenge_id = info['id']
      solution_file = File.join(Dir.pwd, info['file_name'])

      if File.exists?(solution_file)
        Comet::API.submit(@config, challenge_id, solution_file)
      else
        puts "Missing solution file (#{solution_file})."
        exit 1
      end
    else
      puts "This is not a challenge directory."
      exit 1
    end
  end
end

pre do |global,command,options,args|
  @config = Comet::Init.find_config(Dir.pwd)
  !@config.nil?
end

post do |global,command,options,args|
  # Post logic here
  # Use skips_post before a command to skip this
  # block on that command only
end

on_error do |exception|
  # Error logic here
  # return false to skip default error handling
  true
end

exit run(ARGV)
